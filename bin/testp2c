#!/bin/bash
#
# Test p2c translation, compilation, and execution of a sample program.
#
# Usage: testp2c <program>
#   e.g.: testp2c hello
#
# Must be run from the sample_programs directory.
# Translates <program>.pas to C, compiles, runs with <program>.inp,
# and diffs the output against <program>.cmp.
#
# Errors from p2c and gcc are collected in <program>.err.
#
# If P2C_RESULTS is set, the summary table line is also appended to that file.
#

if [ $# -ne 1 ]; then
    echo "Usage: testp2c <program>"
    echo "  e.g.: testp2c hello"
    exit 1
fi

prog=$1

# output a result line to stdout and optionally to P2C_RESULTS file
result_line() {
    printf "%-12s p2c: %3s  gcc: %5s  dif: %s\n" "$@"
    if [ -n "$P2C_RESULTS" ]; then
        printf "%-12s p2c: %3s  gcc: %5s  dif: %s\n" "$@" >> "$P2C_RESULTS"
    fi
}

# Check source exists
if [ ! -f "${prog}.pas" ]; then
    echo "Error: ${prog}.pas not found"
    exit 1
fi

# Clear error file
> ${prog}.err

# Translate with p2c
echo "Translating ${prog}.pas"
../bin/p2c $prog >> ${prog}.err 2>&1
p2cerrs=$(grep "Errors in program:" ${prog}.err | sed 's/.*: //' | tr -d ' ')
if [ "$p2cerrs" != "0" ]; then
    result_line "$prog" "$p2cerrs" "n/a" "n/a"
    exit 1
fi

# Compile with gcc
echo "Compiling ${prog}.c"
gcc -o ${prog}_c ${prog}.c -I../libs ../libs/setopr.o -lm 2>>${prog}.err
gccerrs=$(grep -c "error:" ${prog}.err)
if [ "$gccerrs" -gt 0 ]; then
    result_line "$prog" "$p2cerrs" "$gccerrs" "n/a"
    exit 1
fi

# Run the program
echo "Running ${prog}_c"
# Build command-line args from .dat file if program uses argc/argv
if grep -q 'int main(int argc' ${prog}.c && [ -f "${prog}.dat" ]; then
    args="${prog}.dat"
else
    args=""
fi
if [ -f "${prog}.inp" ]; then
    ./${prog}_c $args < ${prog}.inp > ${prog}.lst 2>&1
else
    ./${prog}_c $args > ${prog}.lst 2>&1
fi
if [ $? -ne 0 ]; then
    result_line "$prog" "$p2cerrs" "$gccerrs" "FAIL"
    exit 1
fi

# Compare output (strip interpreter decorations from both sides)
diflines=0
if [ -f "${prog}.cmp" ]; then
    echo "Comparing ${prog}.lst to ${prog}.cmp"
    ../bin/strip ${prog}.lst ${prog}.lst.strp
    ../bin/strip ${prog}.cmp ${prog}.cmp.strp
    diff ${prog}.lst.strp ${prog}.cmp.strp > ${prog}.dif
    diflines=$(grep -c "^[<>]" ${prog}.dif)
    rm -f ${prog}.lst.strp ${prog}.cmp.strp
fi

result_line "$prog" "$p2cerrs" "$gccerrs" "$diflines"
if [ "$diflines" -gt 0 ]; then
    exit 1
fi
