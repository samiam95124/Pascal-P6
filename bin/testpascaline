#!/bin/bash
#
# Script to run Pascaline test suite
#
# Execution:
#
# testpascaline [--pmach|--cmach|--pint]
#
# The flags are one of:
#
# --pmach Generate mach code and run the result through pmach.
# --cmach Generate mach code and run the result through cmach.
# --pint  Generate mach code and run the result through pint (default).
#
cd pascaline_tests

#
# Compile sources
#
compile $1 pascaline2 pascaline1 pascaline

#
# Form combined deck
#
cat pascaline.p6 > prd

#
# Run test with parameters
#
if [ "$1" = "--pmach" ]; then

	echo Running with pmach
    cp pascaline.p6 prd
    pint pascaline.p6 pascaline.p6o --machdeck
    pmach pascaline.p6o temp headertest1 headertest2 42 123.456 hi there < pascaline.inp > pascaline.lst
    diffnolestrip pascaline.lst pascaline_pmach.cmp > pascaline.dif
    wc -l pascaline_pmach.dif
    
elif [ "$1" = "--cmach" ]; then

	echo Running with cmach
    pint pascaline.p6 pascaline.p6o --machdeck
    cmach pascaline.p6o headertest1 headertest2 42 123.456 hi there < pascaline.inp > pascaline.lst
    diffnolestrip pascaline.lst pascaline_cmach.cmp > pascaline.dif
    wc -l pascaline_cmach.dif
    
elif [ "$1" = "--pgen" ]; then

    Echo Cannot run with pgen
    exit 0

else

	echo Running with pint
    pint pascaline.p6 temp headertest1 headertest2 42 123.456 hi there < pascaline.inp > pascaline.lst
    diffnolestrip pascaline.lst pascaline.cmp > pascaline.dif
    wc -l pascaline.dif
    
fi
