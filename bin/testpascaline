#!/bin/bash
#
# Script to run Pascaline test suite
#
# Execution:
#
# testpascaline [--pmach|--cmach|--pint]
#
# The flags are one of:
#
# --pmach Generate mach code and run the result through pmach.
# --cmach Generate mach code and run the result through cmach.
# --pint  Generate mach code and run the result through pint (default).
#
cd pascaline_tests

#
# Compile sources
#
compile $1 pascaline2 pascaline1 pascaline

#
# Form combined deck
#
cat pascaline.p6 > prd

#
# Run test with parameters
#
if [ "$1" = "--pmach" ]; then

	echo Running with pmach
    cp pascaline.p6 prd
    pint --e
    mv prr pascaline.p6o
    cat pascaline.p6o $inpfile > prd
    pmach headertest1 headertest2 42 123.456 hi there < pascaline.inp > pascaline.lst
    diffnole pascaline.lst pascaline_pmach.cmp > pascaline_pmach.dif
    wc -l pascaline_pmach.dif
    
elif [ "$1" = "--cmach" ]; then

	echo Running with cmach
    cp pascaline.p6 prd
    pint --e
    mv prr pascaline.p6o
    cat pascaline.p6o $inpfile > prd
    cmach headertest1 headertest2 42 123.456 hi there < pascaline.inp > pascaline.lst
    diffnole pascaline.lst pascaline_cmach.cmp > pascaline_cmach.dif
    wc -l pascaline_cmach.dif
    
else

	echo Running with pint
    cat pascaline.p6 $inpfile > prd
    pint headertest1 headertest2 42 123.456 hi there < pascaline.inp > pascaline.lst
    diffnole pascaline.lst pascaline.cmp > pascaline.dif
    wc -l pascaline.dif
    
fi
