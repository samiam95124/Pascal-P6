#!/bin/bash
#
# Script to run a pcom self compile
#
# First, change elide patterns to #ove prr file statements.
# The modified file goes in pcomm.pas (pcom modified).
#
sed -e 's/{elide}/{/g' -e 's/{noelide}/}/g' source/pcom.pas > pcomm.pas
#
# Compile pcom to intermediate code using its binary version.
#
echo Compiling pcom to intermediate code
compile pcomm
cat pcomm.err
#
# Now run that code on the interpreter and have it compile itself
# to intermediate again.
#
echo Running pcom to compile itself

cat pcomm.p5 pcomm.pas > tmp.p5
mv pcomm.p5 pcomm.p5.org
cp tmp.p5 pcomm.p5
echo > pcomm.inp

run pcomm
cat pcomm.lst
#
# Now we have the original intermediate from the binary version
# of pcom, and the intermediate generated by the interpreted
# pcom. Compare them for equality. Put the result in pcomm.dif.
#
echo -n "Comparing the intermediate code for the runs ... "
diffnole pcomm.p5.org pcomm.out > pcomm.dif
#
# Show the file, so if the length is zero, it compared ok.
#
#echo Resulting diff file length should be zero for pass
if test -s pcomm.dif
then
    echo FAILED
else
    echo PASS
fi
echo
#ls -l pcomm.dif
